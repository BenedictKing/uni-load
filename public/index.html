<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>uni-load - AI站点配置器</title>
    <link rel="icon" href="/logo.svg" type="image/svg+xml" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: white;
        padding: 30px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .form-container {
        padding: 40px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
        font-size: 1.1em;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      /* API基础地址输入框容器样式 */
      .input-with-badge {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-with-badge input {
        flex: 1;
        padding-right: 120px; /* 为右侧胶囊留出空间 */
      }

      /* 站点名称胶囊样式 */
      .site-name-badge {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: all 0.3s ease;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
      }

      .site-name-badge.loading {
        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
      }

      .site-name-badge.error {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #4caf50;
        background: white;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .form-group textarea {
        height: 120px;
        resize: vertical;
        font-family: 'Courier New', monospace;
      }

      .btn-submit {
        width: 100%;
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: white;
        border: none;
        padding: 18px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
      }

      .btn-submit:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(86, 171, 47, 0.4);
      }

      .btn-submit:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .result {
        margin-top: 30px;
        padding: 20px;
        border-radius: 10px;
        display: none;
      }

      .result.success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 1px solid #c3e6cb;
        color: #155724;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
      }

      .result.error {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border: 1px solid #f5c6cb;
        color: #721c24;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
      }

      .loading {
        text-align: center;
        padding: 20px;
        display: none;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .help-text {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
      }

      .example {
        background: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .checkbox-group {
        margin-top: 10px;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: normal;
        font-size: 16px;
        white-space: nowrap;
      }

      .checkbox-item input[type='checkbox'] {
        margin-right: 12px;
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-item:hover {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .sync-panel {
        margin-top: 40px;
        padding: 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
      }

      .sync-panel:hover {
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }

      .sync-panel h3 {
        margin-bottom: 20px;
        color: #495057;
        font-weight: 600;
      }

      .sync-status {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .sync-controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn-sync,
      .btn-control,
      .btn-refresh,
      .btn-warning {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-sync {
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
      }

      .btn-sync:hover {
        background: linear-gradient(135deg, #138496 0%, #1ba085 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.4);
      }

      .btn-control {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: #212529;
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
      }

      .btn-control:hover {
        background: linear-gradient(135deg, #e0a800 0%, #e8590c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
      }

      .btn-refresh {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
      }

      .btn-refresh:hover {
        background: linear-gradient(135deg, #545b62 0%, #343a40 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.4);
      }

      .btn-warning {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
      }

      .btn-warning:hover {
        background: linear-gradient(135deg, #c82333 0%, #e8590c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        color: white;
        box-shadow: 0 2px 4px rgba(111, 66, 193, 0.3);
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #5a32a3 0%, #d91a72 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(111, 66, 193, 0.4);
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        position: relative;
      }

      /* 运行状态 - 绿色脉冲 */
      .status-running {
        background: #28a745;
        animation: pulse-green 2s infinite;
      }

      .status-running::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #28a745;
        animation: pulse-ring 2s infinite;
      }

      /* 停止状态 - 红色 */
      .status-stopped {
        background: #dc3545;
        animation: pulse-red 3s infinite;
      }

      /* 空闲状态 - 黄色脉冲 */
      .status-idle {
        background: #ffc107;
        animation: pulse-yellow 2.5s infinite;
      }

      /* 脉冲动画 */
      @keyframes pulse-green {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      @keyframes pulse-red {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }

      @keyframes pulse-yellow {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      @keyframes pulse-ring {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(1.8);
          opacity: 0;
        }
      }
      /* 渠道列表样式 */
      .channels-list {
        margin-top: 1rem;
      }

      /* 单个渠道项目样式 */
      .channel-item {
        display: flex;
        flex-direction: column;
        padding: 1.2rem;
        border: 1px solid #e1e5e9;
        border-radius: 12px;
        background: white;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .channel-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        opacity: 0.7;
        transition: all 0.3s ease;
      }

      /* OpenAI 渠道卡片 - 绿色边框 */
      .channel-item[data-channel-type="openai"]::before,
      .channel-item:has(.channel-type-badge.openai)::before {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      /* Anthropic 渠道卡片 - 紫色边框 */
      .channel-item[data-channel-type="anthropic"]::before,
      .channel-item:has(.channel-type-badge.anthropic)::before {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      }

      /* Gemini 渠道卡片 - 蓝色边框 */
      .channel-item[data-channel-type="gemini"]::before,
      .channel-item:has(.channel-type-badge.gemini)::before {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      }

      .channel-item:hover::before {
        opacity: 1;
        width: 6px;
      }

      .channel-item:hover {
        background: #f8f9fa;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
      }

      .channel-info {
        flex: 1;
        min-width: 0; /* 允许内容截断 */
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }

      .channel-name {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        margin-bottom: 0.3rem;
        flex-wrap: wrap;
      }

      .channel-name strong {
        color: #2c3e50;
        font-size: 1.15em;
        font-weight: 600;
        flex: 1;
        min-width: 200px;
      }

      /* 渠道类型标记基础样式 */
      .channel-type-badge {
        color: white;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
      }

      /* OpenAI 渠道类型 - 绿色主题 */
      .channel-type-badge.openai,
      .channel-type-badge[data-type="openai"] {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
      }

      .channel-type-badge.openai:hover,
      .channel-type-badge[data-type="openai"]:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
      }

      /* Anthropic 渠道类型 - 紫色主题 */
      .channel-type-badge.anthropic,
      .channel-type-badge[data-type="anthropic"] {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
      }

      .channel-type-badge.anthropic:hover,
      .channel-type-badge[data-type="anthropic"]:hover {
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4);
      }

      /* Gemini 渠道类型 - 蓝色主题 */
      .channel-type-badge.gemini,
      .channel-type-badge[data-type="gemini"] {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      }

      .channel-type-badge.gemini:hover,
      .channel-type-badge[data-type="gemini"]:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
      }

      /* 其他渠道类型 - 灰色主题 */
      .channel-type-badge.default,
      .channel-type-badge:not(.openai):not(.anthropic):not(.gemini):not([data-type]) {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
      }

      .channel-type-badge.default:hover,
      .channel-type-badge:not(.openai):not(.anthropic):not(.gemini):not([data-type]):hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
      }

      .channel-details {
        display: flex;
        gap: 1.2rem;
        flex-wrap: wrap;
        font-size: 0.9em;
        color: #6c757d;
        background: #f8f9fa;
        padding: 0.8rem;
        border-radius: 8px;
        border-left: 3px solid #e9ecef;
      }

      .detail-item {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
        gap: 0.3rem;
      }

      .detail-item::before {
        content: '•';
        color: #adb5bd;
        font-weight: bold;
      }

      .detail-item:first-child::before {
        content: '';
      }

      .channel-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-top: 0.8rem;
        padding-top: 0.8rem;
        border-top: 1px solid #e9ecef;
        flex-wrap: wrap;
      }

      .channel-action-group {
        display: flex;
        gap: 0.6rem;
        align-items: center;
      }

      .channel-reassign-group {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        padding: 0.5rem 0.8rem;
        border-radius: 10px;
        border: 1px solid #90caf9;
        box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);
      }

      .channel-management-group {
        display: flex;
        gap: 0.6rem;
      }

      .btn-update {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
      }

      .btn-update:hover {
        background: linear-gradient(135deg, #218838 0%, #1ba085 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .btn-delete {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
      }

      .btn-delete:hover {
        background: linear-gradient(135deg, #c82333 0%, #e8590c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
      }

      .btn-promote,
      .btn-demote {
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        white-space: nowrap;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .btn-promote {
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        color: white;
      }

      .btn-promote:hover {
        background: linear-gradient(135deg, #138496 0%, #1ba085 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
      }

      .btn-demote {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: #212529;
      }

      .btn-demote:hover {
        background: linear-gradient(135deg, #e0a800 0%, #e8590c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
      }

      /* 按钮禁用状态 */
      .btn-update:disabled,
      .btn-delete:disabled,
      .btn-promote:disabled,
      .btn-demote:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .channel-item {
          padding: 1rem;
          margin-bottom: 0.8rem;
        }

        .channel-info {
          gap: 0.6rem;
        }

        .channel-name {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
          margin-bottom: 0.2rem;
        }

        .channel-name strong {
          min-width: auto;
          font-size: 1.1em;
        }

        .channel-details {
          flex-direction: column;
          gap: 0.5rem;
          padding: 0.6rem;
        }

        .channel-actions {
          flex-direction: column;
          gap: 0.8rem;
          align-items: stretch;
        }

        .channel-action-group {
          justify-content: center;
          gap: 0.5rem;
        }

        .detail-item {
          overflow: visible;
          white-space: normal;
        }

        .btn-update,
        .btn-delete,
        .btn-promote,
        .btn-demote {
          padding: 0.5rem 1rem;
          font-size: 0.85em;
        }
      }

      /* 超小屏幕适配 */
      @media (max-width: 480px) {
        .channel-item {
          padding: 0.8rem;
        }

        .channel-name {
          font-size: 1em;
        }

        .channel-actions {
          gap: 0.6rem;
        }

        .channel-action-group {
          flex-direction: column;
          gap: 0.4rem;
        }

        .btn-update,
        .btn-delete,
        .btn-promote,
        .btn-demote {
          width: 100%;
          text-align: center;
        }
      }

      /* 模态框样式 */
      .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e1e5e9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8f9fa;
        border-radius: 15px 15px 0 0;
      }

      .modal-header h3 {
        margin: 0;
        color: #333;
      }

      .close {
        font-size: 24px;
        cursor: pointer;
        color: #666;
        background: none;
        border: none;
      }

      .close:hover {
        color: #000;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .info-display {
        background: #f8f9fa;
        padding: 0.8rem;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        border: 1px solid #e1e5e9;
        color: #495057;
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .btn-primary {
        background: #4caf50;
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        flex: 1;
      }

      .btn-primary:hover {
        background: #45a049;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        flex: 1;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      /* 折叠区域样式 */
      .collapsible-section {
        margin-bottom: 25px;
      }

      .collapsible-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        padding: 12px 15px;
        background: #f8f9fa;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        transition: all 0.3s ease;
        user-select: none;
      }

      .collapsible-header:hover {
        background: #e9ecef;
        border-color: #ced4da;
      }

      .collapsible-header label {
        margin: 0;
        cursor: pointer;
        font-weight: 600;
        color: #555;
        font-size: 1.1em;
      }

      .collapsible-toggle {
        font-size: 18px;
        font-weight: bold;
        color: #6c757d;
        transition: transform 0.3s ease;
        min-width: 20px;
        text-align: center;
      }

      .collapsible-content {
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        max-height: 0;
        padding: 0 15px;
      }

      .collapsible-content.expanded {
        max-height: 200px; /* 足够高以容纳textarea */
        padding: 15px;
      }

      .collapsible-header.expanded .collapsible-toggle {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🚀 uni-load</h1>
        <p>AI站点自动配置工具 - 连接 uni-api 与 gpt-load</p>
      </div>

      <div class="form-container">
        <form id="aiSiteForm">
          <div class="form-group">
            <label for="baseUrl">API 基础地址 *</label>
            <div class="input-with-badge">
              <input
                type="url"
                id="baseUrl"
                name="baseUrl"
                required
                placeholder="https://api.example.com"
                oninput="debouncedUpdateSiteName()" />
              <span id="generatedSiteName" class="site-name-badge loading">
                请输入地址
              </span>
            </div>
            <div class="help-text">AI站点的API地址，系统会自动生成站点名称</div>
          </div>

          <div class="form-group">
            <label>API 格式类型 * (可多选)</label>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input
                  type="checkbox"
                  id="channelType_openai"
                  name="channelTypes"
                  value="openai"
                  checked
                  onchange="updateValidationEndpointHelp()" />
                <span class="checkmark"></span>
                OpenAI 兼容格式
              </label>
              <label class="checkbox-item">
                <input
                  type="checkbox"
                  id="channelType_anthropic"
                  name="channelTypes"
                  value="anthropic"
                  onchange="updateValidationEndpointHelp()" />
                <span class="checkmark"></span>
                Anthropic Claude 格式
              </label>
              <label class="checkbox-item">
                <input
                  type="checkbox"
                  id="channelType_gemini"
                  name="channelTypes"
                  value="gemini"
                  onchange="updateValidationEndpointHelp()" />
                <span class="checkmark"></span>
                Google Gemini 格式
              </label>
            </div>
            <div class="help-text">选择该AI站点支持的API格式</div>
          </div>

          <div class="form-group">
            <label for="apiKeys">API 密钥 *</label>
            <textarea
              id="apiKeys"
              name="apiKeys"
              required
              placeholder="sk-xxx...&#10;sk-yyy..., sk-zzz...&#10;sk-aaa... sk-bbb...; sk-ccc...&#10;&#10;支持分隔符：换行、空格、逗号、分号"
              rows="6"></textarea>
          </div>

          <!-- 手动指定模型 - 可折叠区域 -->
          <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('manualModelsSection')">
              <label>手动指定模型 (可选)</label>
              <span class="collapsible-toggle">▼</span>
            </div>
            <div id="manualModelsSection" class="collapsible-content">
              <div class="form-group" style="margin-bottom: 10px;">
                <textarea
                  id="manualModels"
                  name="manualModels"
                  placeholder="如果站点无法自动获取模型列表，可以手动指定：&#10;gpt-3.5-turbo&#10;gpt-4&#10;claude-3-sonnet&#10;deepseek-chat&#10;&#10;每行一个模型名称"
                  rows="4"></textarea>
                <div class="help-text">仅当自动获取模型失败时使用。每行一个模型名称。</div>
              </div>
            </div>
          </div>

          <!-- 新的动态验证端点输入区域 -->
          <div id="validationEndpointsContainer">
            <div id="validationEndpoint_openai_group" class="form-group" style="display: none">
              <label for="validationEndpoint_openai">验证端点 (OpenAI 格式)</label>
              <input
                type="text"
                id="validationEndpoint_openai"
                name="validationEndpoint_openai"
                placeholder="留空则使用默认值 /v1/chat/completions" />
              <div class="help-text">用于 OpenAI 格式的健康检查端点。</div>
            </div>
            <div id="validationEndpoint_anthropic_group" class="form-group" style="display: none">
              <label for="validationEndpoint_anthropic">验证端点 (Claude 格式)</label>
              <input
                type="text"
                id="validationEndpoint_anthropic"
                name="validationEndpoint_anthropic"
                placeholder="留空则使用默认值 /v1/messages" />
              <div class="help-text">用于 Anthropic Claude 格式的健康检查端点。</div>
            </div>
            <div id="validationEndpoint_gemini_group" class="form-group" style="display: none">
              <label for="validationEndpoint_gemini">验证端点 (Gemini 格式)</label>
              <input
                type="text"
                id="validationEndpoint_gemini"
                name="validationEndpoint_gemini"
                placeholder="留空则使用默认值 /v1beta/models" />
              <div class="help-text">用于 Google Gemini 格式的健康检查端点。</div>
            </div>
          </div>

          <button type="submit" class="btn-submit" id="submitBtn">🔧 开始配置</button>
        </form>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>正在配置中，请稍候...</p>
        </div>

        <div class="result" id="result"></div>

        <!-- 模型同步控制面板 -->
        <div class="sync-panel">
          <h3>🔄 模型同步服务</h3>
          <div class="sync-status" id="syncStatus">
            <p>正在获取状态...</p>
          </div>
          <div class="sync-controls">
            <button type="button" class="btn-sync" onclick="triggerManualSync()">
              🔄 手动同步
            </button>
            <button type="button" class="btn-control" id="syncControlBtn" onclick="toggleSyncService()">
              ⚙️ 控制服务
            </button>
            <button type="button" class="btn-refresh" onclick="refreshSyncStatus()">
              🔄 刷新状态
            </button>
            <button type="button" class="btn-warning" onclick="cleanupAndResetModels()">
              🗑️ 清理重置
            </button>
          </div>
        </div>

        <!-- 临时分组清理面板 -->
        <div class="sync-panel">
          <h3>🧹 临时分组清理</h3>
          <div class="sync-status" id="tempGroupsStatus">
            <p>正在获取统计...</p>
          </div>
          <div class="sync-controls">
            <button type="button" class="btn-refresh" onclick="refreshTempGroupsStats()">
              📊 刷新统计
            </button>
            <button type="button" class="btn-warning" onclick="cleanupAllTempGroups()">
              🗑️ 清理所有分组
            </button>
            <button type="button" class="btn-secondary" onclick="cleanupOldTempGroups()">
              ⏰ 清理24小时前
            </button>
          </div>
        </div>

        <!-- 渠道健康监控面板 -->
        <div class="sync-panel">
          <h3>🩺 渠道健康监控</h3>
          <div class="sync-status" id="channelHealthStatus">
            <p>正在获取状态...</p>
          </div>
          <div class="sync-controls">
            <button type="button" class="btn-sync" onclick="triggerChannelCheck()">
              ❤️ 健康检查
            </button>
            <button type="button" class="btn-control" id="healthControlBtn" onclick="toggleHealthMonitor()">
              ⚙️ 控制服务
            </button>
            <button type="button" class="btn-warning" onclick="showFailedChannels()">
              ⚠️ 查看失败渠道
            </button>
            <button type="button" class="btn-refresh" onclick="refreshChannelHealthStatus()">
              🔄 刷新状态
            </button>
          </div>
          <!-- 新增一个用于显示渠道列表的容器 -->
          <div id="channelListContainer" style="margin-top: 15px"></div>
        </div>
      </div>
    </div>
    <!-- 更新渠道模态框 -->
    <div id="updateChannelModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>🔄 更新渠道配置</h3>
          <span class="close" onclick="closeUpdateModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="updateChannelForm">
            <input type="hidden" id="updateChannelName" />
            <input type="hidden" id="updateOriginalBaseUrl" />
            <input type="hidden" id="updateChannelType" />

            <div class="form-group">
              <label>渠道名称：</label>
              <div class="info-display" id="updateChannelDisplayName"></div>
            </div>

            <div class="form-group">
              <label>原始地址：</label>
              <div class="info-display" id="updateBaseUrlDisplay"></div>
            </div>

            <div class="form-group">
              <label for="updateApiKeys">🔑 API 密钥 (可选)</label>
              <textarea
                id="updateApiKeys"
                placeholder="留空则保持现有密钥不变&#10;如需添加新密钥，请输入:&#10;sk-xxx...&#10;sk-yyy..."
                rows="4"></textarea>
              <div class="help-text">留空则保持现有API密钥不变，填写则会添加新的密钥到现有密钥中</div>
            </div>

            <div class="modal-actions">
              <button type="submit" class="btn-primary">🔄 更新配置</button>
              <button type="button" class="btn-secondary" onclick="closeUpdateModal()">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
      // 自动生成站点名称 - 通过后端API
      async function updateSiteName() {
        const baseUrlInput = document.getElementById('baseUrl')
        const siteNameBadge = document.getElementById('generatedSiteName')
        const baseUrl = baseUrlInput.value.trim()

        if (!baseUrl) {
          siteNameBadge.textContent = '请输入地址'
          siteNameBadge.className = 'site-name-badge loading'
          return
        }

        // 显示加载状态
        siteNameBadge.textContent = '生成中...'
        siteNameBadge.className = 'site-name-badge loading'

        try {
          // 调用后端API获取站点名称
          const response = await fetch('/api/preview-site-name', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ baseUrl }),
          })

          const data = await response.json()

          if (response.ok) {
            siteNameBadge.textContent = data.siteName
            siteNameBadge.className = 'site-name-badge'
            siteNameBadge.title = `站点名称: ${data.siteName}` // 添加tooltip显示完整名称
          } else {
            siteNameBadge.textContent = '生成失败'
            siteNameBadge.className = 'site-name-badge error'
            siteNameBadge.title = data.error || '无法生成站点名称'
          }
        } catch (error) {
          siteNameBadge.textContent = '网络错误'
          siteNameBadge.className = 'site-name-badge error'
          siteNameBadge.title = '网络错误，无法生成站点名称'
        }
      }

      // 防抖函数，避免频繁调用API
      let debounceTimer
      function debouncedUpdateSiteName() {
        clearTimeout(debounceTimer)
        debounceTimer = setTimeout(updateSiteName, 500) // 500ms 延迟
      }

      // 折叠/展开功能
      function toggleCollapsible(sectionId) {
        const content = document.getElementById(sectionId)
        const header = content.previousElementSibling
        
        if (content.classList.contains('expanded')) {
          // 收起
          content.classList.remove('expanded')
          header.classList.remove('expanded')
        } else {
          // 展开
          content.classList.add('expanded')
          header.classList.add('expanded')
        }
      }

      // 动态更新验证端点的帮助信息
      function updateValidationEndpointHelp() {
        const checkedTypes = Array.from(document.querySelectorAll('input[name="channelTypes"]:checked')).map(
          (cb) => cb.value
        )
        const allTypes = ['openai', 'anthropic', 'gemini']

        allTypes.forEach((type) => {
          const groupDiv = document.getElementById(`validationEndpoint_${type}_group`)
          if (groupDiv) {
            if (checkedTypes.includes(type)) {
              groupDiv.style.display = 'block'
            } else {
              groupDiv.style.display = 'none'
            }
          }
        })
      }

      function addApiKey() {
        // 这个函数不再需要，但保留以防止错误
      }

      function removeApiKey(button) {
        // 这个函数不再需要，但保留以防止错误
      }

      // 解析多行API密钥文本
      function parseApiKeys(text) {
        if (!text || !text.trim()) {
          return []
        }

        // 使用多种分隔符：换行、空格、逗号、分号
        const keys = text
          .split(/[\n\r\s,;]+/) // 按换行、空格、逗号、分号分割
          .map((key) => key.trim()) // 去除首尾空格
          .filter((key) => key.length > 0) // 过滤空字符串
          .filter((key, index, arr) => arr.indexOf(key) === index) // 去重

        return keys
      }

      // 解析手动模型列表
      function parseManualModels(text) {
        if (!text || !text.trim()) {
          return []
        }

        const models = text
          .split(/[\n\r]+/) // 按换行分割
          .map((model) => model.trim()) // 去除首尾空格
          .filter((model) => model.length > 0) // 过滤空字符串
          .filter((model, index, arr) => arr.indexOf(model) === index) // 去重

        return models
      }

      document.getElementById('aiSiteForm').addEventListener('submit', async function (e) {
        e.preventDefault()

        const submitBtn = document.getElementById('submitBtn')
        const loading = document.getElementById('loading')
        const result = document.getElementById('result')

        // 收集表单数据
        const baseUrl = document.getElementById('baseUrl').value.trim()

        // 收集选中的 channelTypes
        const channelTypeCheckboxes = document.querySelectorAll('input[name="channelTypes"]:checked')
        const channelTypes = Array.from(channelTypeCheckboxes).map((cb) => cb.value)

        if (channelTypes.length === 0) {
          alert('请至少选择一种API格式类型')
          return
        }

        // 通过API获取站点名称
        let siteName
        try {
          const response = await fetch('/api/preview-site-name', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ baseUrl }),
          })

          const data = await response.json()

          if (response.ok) {
            siteName = data.siteName
          } else {
            alert('无法生成站点名称: ' + (data.error || '未知错误'))
            return
          }
        } catch (error) {
          alert('获取站点名称失败: ' + error.message)
          return
        }

        // 解析多行API密钥文本
        const apiKeysText = document.getElementById('apiKeys').value
        const apiKeys = parseApiKeys(apiKeysText)

        // 解析手动模型列表
        const manualModelsText = document.getElementById('manualModels').value
        const manualModels = parseManualModels(manualModelsText)

        // 收集自定义验证端点
        const customValidationEndpoints = {}
        channelTypes.forEach((type) => {
          const input = document.getElementById(`validationEndpoint_${type}`)
          if (input && input.value.trim()) {
            customValidationEndpoints[type] = input.value.trim()
          }
        })

        if (apiKeys.length === 0) {
          alert('请至少输入一个API密钥')
          return
        }

        // 显示加载状态
        submitBtn.disabled = true
        loading.style.display = 'block'
        result.style.display = 'none'

        try {
          const response = await fetch('/api/process-ai-site', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              siteName,
              baseUrl,
              apiKeys,
              channelTypes,
              customValidationEndpoints, // 使用新的对象
              models: manualModels.length > 0 ? manualModels : undefined, // 只有在有手动模型时才发送
            }),
          })

          const data = await response.json()

          if (data.success) {
            result.className = 'result success'

            // 构建分类的模型列表HTML
            let modelsHtml = '';
            const modelsByChannel = data.data.modelsByChannel;
            for (const channelType in modelsByChannel) {
                if (modelsByChannel[channelType].length > 0) {
                    modelsHtml += `<h4>${channelType.charAt(0).toUpperCase() + channelType.slice(1)} 格式模型:</h4>`;
                    modelsHtml += '<ul style="margin-left: 20px; margin-top: 5px; margin-bottom: 15px;">';
                    modelsByChannel[channelType].forEach(model => {
                        modelsHtml += `<li>${model}</li>`;
                    });
                    modelsHtml += '</ul>';
                }
            }

            result.innerHTML = `
                        <h3>✅ 配置成功！</h3>
                        <p><strong>站点名称:</strong> ${data.data.siteName}</p>
                        <p><strong>API格式:</strong> ${data.data.channelTypes.join(', ')}</p>
                        <p><strong>创建分组:</strong> ${data.data.groupsCreated} 个</p>
                        <p><strong>发现模型:</strong> ${data.data.modelsCount} 个 ${
              data.data.usingManualModels ? '(手动指定)' : '(自动获取)'
            }</p>
                        <p><strong>模型列表:</strong></p>
                        <div style="margin-left: 20px; margin-top: 10px;">
                            ${modelsHtml}
                        </div>
                        <p style="margin-top: 15px; color: #28a745;">
                            <strong>✨ 现在可以通过 uni-api 访问这些模型了！</strong>
                        </p>
                    `
          } else {
            throw new Error(data.error || '配置失败')
          }
        } catch (error) {
          result.className = 'result error'
          result.innerHTML = `
                    <h3>❌ 配置失败</h3>
                    <p><strong>错误信息:</strong> ${error.message}</p>
                    <p>请检查输入的信息是否正确，或查看控制台获取更多详情。</p>
                `
        } finally {
          submitBtn.disabled = false
          loading.style.display = 'none'
          result.style.display = 'block'
        }
      })

      // 页面加载时添加一些示例提示
      document.addEventListener('DOMContentLoaded', function () {
        // 检查服务状态
        fetch('/api/health')
          .then((response) => response.json())
          .then((data) => {
            console.log('✅ uni-load 服务运行正常')
          })
          .catch((error) => {
            console.error('❌ uni-load 服务连接失败:', error)
          })

        // 初始化同步状态
        refreshSyncStatus()

        // 初始化临时分组统计
        refreshTempGroupsStats()

        // 初始化渠道健康状态
        refreshChannelHealthStatus()

        // 初始化验证端点帮助信息
        updateValidationEndpointHelp()
      })

      // 刷新同步状态
      async function refreshSyncStatus() {
        try {
          const response = await fetch('/api/status')
          const data = await response.json()
          updateSyncStatusDisplay(data.modelSync)
        } catch (error) {
          document.getElementById('syncStatus').innerHTML = '<p style="color: #dc3545;">❌ 无法获取同步状态</p>'
        }
      }

      // 临时分组清理相关函数
      // 刷新临时分组统计
      async function refreshTempGroupsStats() {
        try {
          const response = await fetch('/api/temp-groups/stats')
          const data = await response.json()

          if (data.success) {
            updateTempGroupsStatusDisplay(data.data)
          } else {
            document.getElementById('tempGroupsStatus').innerHTML =
              '<p style="color: #dc3545;">❌ 获取统计失败: ' + (data.error || '未知错误') + '</p>'
          }
        } catch (error) {
          document.getElementById('tempGroupsStatus').innerHTML =
            '<p style="color: #dc3545;">❌ 无法获取临时分组统计</p>'
        }
      }

      // 更新临时分组状态显示
      function updateTempGroupsStatusDisplay(stats) {
        const statusEl = document.getElementById('tempGroupsStatus')

        if (stats.totalTempGroups === 0) {
          statusEl.innerHTML = '<p style="color: #28a745;">✅ 无临时分组需要清理</p>'
          return
        }

        let html = `
          <p>发现 <strong>${stats.totalTempGroups}</strong> 个临时分组需要清理</p>
          <div style="margin-top: 10px;">
        `

        stats.instanceStats.forEach((instance) => {
          if (instance.tempGroups.length > 0) {
            html += `
              <div style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <strong>${instance.instanceName}:</strong> ${instance.tempGroups.length} 个分组
                <div style="font-size: 0.9em; margin-top: 4px;">
            `

            instance.tempGroups.forEach((group) => {
              const isDebug = group.name.startsWith('debug-models-')
              const icon = isDebug ? '🛠️' : '🧪'
              html += `<div>${icon} ${group.name} (ID: ${group.id})</div>`
            })

            html += '</div></div>'
          }
        })

        html += '</div>'
        statusEl.innerHTML = html
      }

      // 清理所有临时分组
      async function cleanupAllTempGroups() {
        if (!confirm("您确定要清理所有临时分组吗？\n\n这将删除所有以 'temp-test-' 和 'debug-models-' 开头的分组。")) {
          return
        }

        const btn = event.target
        const originalText = btn.textContent

        try {
          btn.disabled = true
          btn.textContent = '清理中...'

          const response = await fetch('/api/temp-groups/cleanup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          })

          const data = await response.json()

          if (data.success) {
            alert('✅ ' + data.message)
            setTimeout(refreshTempGroupsStats, 1000) // 1秒后刷新状态
          } else {
            throw new Error(data.error || '清理失败')
          }
        } catch (error) {
          alert('❌ 清理失败: ' + error.message)
        } finally {
          btn.disabled = false
          btn.textContent = originalText
        }
      }

      // 清理过期临时分组（24小时前创建的）
      async function cleanupOldTempGroups() {
        if (!confirm('您确定要清理24小时前创建的临时分组吗？\n\n这将删除创建时间超过24小时的临时分组。')) {
          return
        }

        const btn = event.target
        const originalText = btn.textContent

        try {
          btn.disabled = true
          btn.textContent = '清理中...'

          const response = await fetch('/api/temp-groups/cleanup-old', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ hoursOld: 24 }),
          })

          const data = await response.json()

          if (data.success) {
            alert('✅ ' + data.message)
            setTimeout(refreshTempGroupsStats, 1000) // 1秒后刷新状态
          } else {
            throw new Error(data.error || '清理失败')
          }
        } catch (error) {
          alert('❌ 清理失败: ' + error.message)
        } finally {
          btn.disabled = false
          btn.textContent = originalText
        }
      }

      // 更新同步状态显示
      function updateSyncStatusDisplay(syncStatus) {
        const statusDiv = document.getElementById('syncStatus')
        const controlBtn = document.getElementById('syncControlBtn')

        if (!syncStatus) {
          statusDiv.innerHTML = '<p style="color: #dc3545;">❌ 同步服务不可用</p>'
          return
        }

        let statusIndicator = ''
        let statusText = ''

        if (syncStatus.isRunning) {
          statusIndicator = '<span class="status-indicator status-running"></span>'
          statusText = '正在同步中...'
        } else if (syncStatus.hasInterval) {
          statusIndicator = '<span class="status-indicator status-idle"></span>'
          statusText = `服务运行中，每 ${syncStatus.intervalMinutes} 分钟检查一次`
          if (syncStatus.nextSync) {
            statusText += `<br><small>下次同步: ${new Date(syncStatus.nextSync).toLocaleString()}</small>`
          }
        } else {
          statusIndicator = '<span class="status-indicator status-stopped"></span>'
          statusText = '服务已停止'
        }

        statusDiv.innerHTML = `
                <p>${statusIndicator}${statusText}</p>
                <p><small>同步间隔: ${syncStatus.intervalMinutes} 分钟</small></p>
            `

        // 更新控制按钮
        controlBtn.textContent = syncStatus.hasInterval ? '停止服务' : '启动服务'
        controlBtn.style.background = syncStatus.hasInterval ? '#dc3545' : '#28a745'
      }

      // 手动触发同步
      async function triggerManualSync() {
        const btn = event.target
        const originalText = btn.textContent

        try {
          btn.disabled = true
          btn.textContent = '同步中...'

          const response = await fetch('/api/sync-models', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          })

          const data = await response.json()

          if (data.success) {
            alert('✅ ' + data.message)
            setTimeout(refreshSyncStatus, 2000) // 2秒后刷新状态
          } else {
            throw new Error(data.error || '同步失败')
          }
        } catch (error) {
          alert('❌ 手动同步失败: ' + error.message)
        } finally {
          btn.disabled = false
          btn.textContent = originalText
        }
      }

      // 切换同步服务状态
      async function toggleSyncService() {
        const btn = document.getElementById('syncControlBtn')
        const isRunning = btn.textContent === '停止服务'
        const action = isRunning ? 'stop' : 'start'

        try {
          btn.disabled = true

          const response = await fetch('/api/sync-models/control', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action }),
          })

          const data = await response.json()

          if (data.success) {
            alert('✅ ' + data.message)
            refreshSyncStatus()
          } else {
            throw new Error(data.error || '操作失败')
          }
        } catch (error) {
          alert('❌ 操作失败: ' + error.message)
        } finally {
          btn.disabled = false
        }
      }

      // 清理并重置所有模型配置
      async function cleanupAndResetModels() {
        if (
          !confirm(
            '您确定要清理所有自动生成的模型分组和相关的uni-api配置吗？\n\n此操作不可逆，通常用于重置或解决配置混乱问题。'
          )
        ) {
          return
        }

        const btn = event.target
        const originalText = btn.textContent

        try {
          btn.disabled = true
          btn.textContent = '清理中...'

          const response = await fetch('/api/maintenance/delete-model-groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          })

          const data = await response.json()

          if (data.success) {
            let successMsg = `✅ ${data.message}\n\n`
            successMsg += `删除的分组: ${data.results.deletedGroups}\n`

            // 如果有失败的分组，也显示出来
            if (data.results.failedGroups > 0) {
              successMsg += `失败的分组: ${data.results.failedGroups}`
            }

            alert(successMsg)

            // 成功后刷新状态
            refreshSyncStatus()
          } else {
            throw new Error(data.error || '清理失败')
          }
        } catch (error) {
          alert('❌ 清理操作失败: ' + error.message)
        } finally {
          btn.disabled = false
          btn.textContent = originalText
        }
      }

      // === 渠道健康监控功能 ===

      // 刷新渠道健康状态
      async function refreshChannelHealthStatus() {
        try {
          // 获取服务状态
          const statusResponse = await fetch('/api/status')
          const statusData = await statusResponse.json()
          updateChannelHealthDisplay(statusData.channelHealth)

          // 获取站点分组列表
          const channelsResponse = await fetch('/api/channels/site-groups')
          const channelsData = await channelsResponse.json()
          if (channelsData.siteGroups) {
            updateChannelListDisplay(channelsData.siteGroups)
          }
        } catch (error) {
          document.getElementById('channelHealthStatus').innerHTML =
            '<p style="color: #dc3545;">❌ 无法获取健康监控状态</p>'
        }
      }

      // 更新渠道健康状态显示
      function updateChannelHealthDisplay(healthStatus) {
        const statusDiv = document.getElementById('channelHealthStatus')
        const controlBtn = document.getElementById('healthControlBtn')

        if (!healthStatus) {
          statusDiv.innerHTML = '<p style="color: #dc3545;">❌ 健康监控服务不可用</p>'
          return
        }

        let statusIndicator = ''
        let statusText = ''

        if (healthStatus.isRunning) {
          statusIndicator = '<span class="status-indicator status-running"></span>'
          statusText = '正在检查渠道健康...'
        } else if (healthStatus.hasInterval) {
          statusIndicator = '<span class="status-indicator status-idle"></span>'
          statusText = `监控运行中，每 ${healthStatus.intervalMinutes} 分钟检查一次`
          if (healthStatus.nextCheck) {
            statusText += `<br><small>下次检查: ${new Date(healthStatus.nextCheck).toLocaleString()}</small>`
          }
        } else {
          statusIndicator = '<span class="status-indicator status-stopped"></span>'
          statusText = '监控已停止'
        }

        let failureInfo = ''
        if (healthStatus.failureCount > 0) {
          failureInfo = `<br><span style="color: #dc3545;"><small>⚠️ ${healthStatus.failureCount} 个渠道存在失败记录</small></span>`
        }

        statusDiv.innerHTML = `
                <p>${statusIndicator}${statusText}${failureInfo}</p>
                <p><small>失败阈值: ${healthStatus.failureThreshold} 次，检查间隔: ${healthStatus.intervalMinutes} 分钟</small></p>
            `

        // 更新控制按钮
        controlBtn.textContent = healthStatus.hasInterval ? '停止监控' : '启动监控'
        controlBtn.style.background = healthStatus.hasInterval ? '#dc3545' : '#28a745'
      }

      // 更新渠道列表显示
      function updateChannelListDisplay(channels) {
        const container = document.getElementById('channelListContainer')
        if (channels.length === 0) {
          container.innerHTML = '<p><small>暂无已配置的渠道分组。</small></p>'
          return
        }

        let html = '<h4>已配置的渠道分组:</h4>'
        html += '<div class="channels-list">'

        channels.forEach((channel) => {
          // 从渠道名称解析信息
          const parts = channel.name.split('-')
          const channelType = parts[parts.length - 1]
          const siteName = parts.slice(0, -1).join('-')

          html += `
            <div class="channel-item">
                <div class="channel-info">
                    <div class="channel-name">
                        <strong>${channel.name}</strong>
                        <span class="channel-type-badge ${channelType.toLowerCase()}" data-type="${channelType.toLowerCase()}">${channelType.toUpperCase()}</span>
                    </div>
                    <div class="channel-details">
                        <span class="detail-item">📍 站点: ${siteName}</span>
                        <span class="detail-item">🖥️ 实例: ${channel._instance.name}</span>
                        <span class="detail-item">🔗 上游: ${channel.upstreams?.[0]?.url || 'N/A'}</span>
                    </div>
                    <div class="channel-actions">
                        <div class="channel-action-group channel-reassign-group">
                            <button class="btn-promote" onclick="reassignChannel('${channel.name}', 'promote', event)">⬆️ 提级</button>
                            <button class="btn-demote" onclick="reassignChannel('${channel.name}', 'demote', event)">⬇️ 降级</button>
                        </div>
                        <div class="channel-action-group channel-management-group">
                            <button class="btn-update" onclick="showUpdateChannelModal('${channel.name}', '${
            channel.upstreams?.[0]?.url || ''
          }', '${channelType}')">
                                🔄 更新
                            </button>
                            <button class="btn-delete" onclick="deleteChannel('${channel.name}', event)">
                                🗑️ 删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `
        })
        html += '</div>'
        container.innerHTML = html
      }

      // 删除指定渠道
      async function deleteChannel(channelName, event) {
        if (
          !confirm(
            `您确定要彻底删除渠道 "${channelName}" 吗？\n\n此操作将同时：\n1. 删除此渠道分组。\n2. 从所有模型分组中移除对此渠道的引用。\n\n操作不可逆！`
          )
        ) {
          return
        }

        const btn = event.target
        const originalText = btn.textContent

        try {
          btn.disabled = true
          btn.textContent = '删除中...'

          const response = await fetch(`/api/channels/${channelName}`, {
            method: 'DELETE',
          })

          const data = await response.json()

          if (data.success) {
            let alertMsg = `✅ 渠道 "${channelName}" 已成功删除。\n\n`
            alertMsg += `更新的模型分组: ${data.data.updatedModelGroups.length}\n`
            alertMsg += `删除的模型分组: ${data.data.deletedModelGroups.length}`
            alert(alertMsg)
            // 刷新列表
            refreshChannelHealthStatus()
          } else {
            throw new Error(data.message || '删除失败')
          }
        } catch (error) {
          alert(`❌ 删除渠道 "${channelName}" 失败: ${error.message}`)
          btn.disabled = false
          btn.textContent = originalText
        }
      }

      // 重新分配渠道实例
      async function reassignChannel(channelName, action, event) {
        const actionText = action === 'promote' ? '提级' : '降级'
        if (!confirm(`您确定要对渠道 "${channelName}" 执行 ${actionText} 操作吗？\n\n这将尝试将其分配到下一个可用实例。`)) {
          return
        }

        const btn = event.target
        const originalText = btn.innerHTML

        try {
          btn.disabled = true
          btn.innerHTML = '处理中...'

          const response = await fetch('/api/channels/reassign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ channelName, action }),
          })

          const data = await response.json()

          if (data.success) {
            alert(`✅ ${data.message}`)
            refreshChannelHealthStatus()
          } else {
            throw new Error(data.message || '操作失败')
          }
        } catch (error) {
          alert(`❌ ${actionText}失败: ${error.message}`)
        } finally {
          btn.disabled = false
          btn.innerHTML = originalText
        }
      }

      // 手动触发渠道健康检查
      async function triggerChannelCheck() {
        const btn = event.target
        const originalText = btn.textContent

        try {
          btn.disabled = true
          btn.textContent = '检查中...'

          const response = await fetch('/api/check-channels', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          })

          const data = await response.json()

          if (data.success) {
            alert('✅ ' + data.message)
            setTimeout(refreshChannelHealthStatus, 2000)
          } else {
            throw new Error(data.error || '检查失败')
          }
        } catch (error) {
          alert('❌ 手动健康检查失败: ' + error.message)
        } finally {
          btn.disabled = false
          btn.textContent = originalText
        }
      }

      // 切换渠道健康监控服务状态
      async function toggleHealthMonitor() {
        const btn = document.getElementById('healthControlBtn')
        const isRunning = btn.textContent === '停止监控'
        const action = isRunning ? 'stop' : 'start'

        try {
          btn.disabled = true

          const response = await fetch('/api/check-channels/control', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action }),
          })

          const data = await response.json()

          if (data.success) {
            alert('✅ ' + data.message)
            refreshChannelHealthStatus()
          } else {
            throw new Error(data.error || '操作失败')
          }
        } catch (error) {
          alert('❌ 操作失败: ' + error.message)
        } finally {
          btn.disabled = false
        }
      }

      // 显示失败的渠道
      async function showFailedChannels() {
        try {
          const response = await fetch('/api/failed-channels')
          const data = await response.json()

          if (data.failedChannels.length === 0) {
            alert('✅ 当前没有失败的渠道')
            return
          }

          let message = '🚨 失败的渠道列表:\n\n'
          data.failedChannels.forEach((channel) => {
            message += `• ${channel.name}: ${channel.failures}/${channel.threshold} 次失败`
            if (channel.willBeRemoved) {
              message += ' (将被移除)'
            }
            message += '\n'
          })

          message += '\n是否要重置所有失败计数?'

          if (confirm(message)) {
            await resetAllChannelFailures()
          }
        } catch (error) {
          alert('❌ 获取失败渠道列表失败: ' + error.message)
        }
      }

      // 重置所有渠道失败计数
      async function resetAllChannelFailures() {
        try {
          const response = await fetch('/api/reset-channel-failures', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
          })

          const data = await response.json()

          if (data.success) {
            alert('✅ ' + data.message)
            refreshChannelHealthStatus()
          } else {
            throw new Error(data.error || '重置失败')
          }
        } catch (error) {
          alert('❌ 重置失败: ' + error.message)
        }
      }
      // 显示更新渠道模态框
      function showUpdateChannelModal(channelName, baseUrl, channelType) {
        document.getElementById('updateChannelName').value = channelName
        document.getElementById('updateOriginalBaseUrl').value = baseUrl
        document.getElementById('updateChannelType').value = channelType

        document.getElementById('updateChannelDisplayName').textContent = channelName
        document.getElementById('updateBaseUrlDisplay').textContent = baseUrl

        // 清空API密钥文本框
        document.getElementById('updateApiKeys').value = ''

        document.getElementById('updateChannelModal').style.display = 'block'
      }

      // 关闭更新模态框
      function closeUpdateModal() {
        document.getElementById('updateChannelModal').style.display = 'none'
      }

      // 点击模态框外部关闭
      window.onclick = function (event) {
        const modal = document.getElementById('updateChannelModal')
        if (event.target === modal) {
          closeUpdateModal()
        }
      }

      // 处理更新表单提交
      document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('updateChannelForm').addEventListener('submit', async function (e) {
          e.preventDefault()

          const channelName = document.getElementById('updateChannelName').value
          const baseUrl = document.getElementById('updateOriginalBaseUrl').value
          const channelType = document.getElementById('updateChannelType').value
          const apiKeysText = document.getElementById('updateApiKeys').value.trim()

          // 如果API密钥为空，设置为空数组，后端会跳过密钥更新
          let apiKeys = []
          if (apiKeysText) {
            apiKeys = parseApiKeys(apiKeysText)
            if (apiKeys.length === 0) {
              alert('API密钥格式错误，请检查输入')
              return
            }
          }

          const submitBtn = e.target.querySelector('button[type="submit"]')
          const originalText = submitBtn.textContent

          try {
            submitBtn.disabled = true
            submitBtn.textContent = '更新中...'

            // 构建请求体，明确指定目标分组和操作类型
            const requestBody = {
              baseUrl: baseUrl,
              channelTypes: [channelType],
              targetChannelName: channelName,  // 明确指定要更新的分组
              operationType: 'update'          // 明确指定为更新操作
            }

            // 只有在用户输入了新密钥时才添加到请求中
            if (apiKeys.length > 0) {
              requestBody.apiKeys = apiKeys
            }

            const response = await fetch('/api/process-ai-site', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestBody),
            })

            const data = await response.json()

            if (data.success) {
              let successMsg = `✅ 渠道 ${channelName} 更新成功！\n\n`

              if (apiKeys.length > 0) {
                successMsg += `新增的密钥数量: ${apiKeys.length}\n`
              } else {
                successMsg += `保持现有API密钥不变\n`
              }

              successMsg += `模型数量: ${data.data.modelsCount}\n\n`

              // 添加分类模型信息
              const modelsByChannel = data.data.modelsByChannel;
              for (const channelType in modelsByChannel) {
                if (modelsByChannel[channelType].length > 0) {
                  successMsg += `${channelType.charAt(0).toUpperCase() + channelType.slice(1)} 格式: ${modelsByChannel[channelType].length} 个模型\n`;
                }
              }

              alert(successMsg)

              // 关闭模态框并刷新列表
              closeUpdateModal()
              refreshChannelHealthStatus()
            } else {
              throw new Error(data.error || '更新失败')
            }
          } catch (error) {
            alert(`❌ 更新渠道失败: ${error.message}`)
          } finally {
            submitBtn.disabled = false
            submitBtn.textContent = originalText
          }
        })
      })
    </script>
  </body>
</html>
